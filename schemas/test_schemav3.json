{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Tradetron Strategy Block Configuration (Complete)",
  "description": "Schema for generating trading strategy blocks from natural language, incorporating all major keywords and utility functions.",
  "type": "object",
  "definitions": {
    "operand": {
      "description": "Can be a static value or a dynamic indicator/keyword/function.",
      "oneOf": [
        { "$ref": "#/definitions/indicator_series_function" },
        { "$ref": "#/definitions/real_time_utility_keyword" },
        { "$ref": "#/definitions/special_function_keyword" },
        { "$ref": "#/definitions/candle_pattern_function" },
        { "type": "number", "title": "Static Number" },
        { "type": "string", "pattern": "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$", "title": "Time String (HH:MM)" }
      ]
    },
    "instrument_definition": {
      "type": "object",
      "properties": {
        "exchange": { "type": "string", "enum": ["NSE", "NFO", "CDS", "MCX", "BSE", "FX", "BITBNS", "NASDAQ-EQ"] },
        "symbol_token": { "type": "string", "description": "The root symbol (e.g., NIFTY 50, RELIANCE, BANKNIFTY)" },
        "instrument_type": { "type": "string", "enum": ["EQUITY", "FUTURE", "CALL", "PUT"] },
        "expiry_config": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["Current Week", "Next Week", "Current Month", "Next Month", "Specific Date"] },
            "offset": { "type": "integer", "description": "0 for Current, 1 for Next, etc." }
          }
        },
        "strike_config": {
          "type": "object",
          "description": "Dynamic strike selection for options",
          "properties": {
            "selection_method": { "type": "string", "enum": ["ATM", "OTM", "ITM", "Strike Price", "ATM SPOT"] },
            "offset": { "type": "integer", "description": "+/-n Steps (ATM)" },
            "custom_price": { "type": "number", "description": "If a specific strike price is provided" }
          }
        }
      },
      "required": ["exchange", "symbol_token"]
    },
    
    "indicator_series_function": {
      "description": "Technical Indicators and OHLCV series. Requires Position/Symbol logic. Position is implied via Position Offset.",
      "type": "object",
      "properties": {
        "function_name": { 
          "type": "string", 
          "enum": [
            "ADX", "ADX Smooth", "Alligator", "ALMA", "AROONDOWN", "AROONUP", "ATR", "Awesome Oscillator", 
            "Balance of Power", "BBPercentage", "Bolinger Band width", "CCI", "Chaikin Money Flow", "CLOSE", 
            "CMO", "Coppock Curve", "DEMA", "DI+", "DI-", "Donchain Ch Lower", "Donchain Ch Middle", 
            "Donchain Ch Upper", "Donchain Ch Width", "DTI", "EMA", "Fisher Transform", "HIGH", "Harmonic Mean", 
            "Hull MA", "HV", "Kaufman Adaptive MA", "Kaufman Efficiency indicator", "Keltner Channels", 
            "Keltner Close", "LINEARREG", "LINEARREG SLOPE", "LINEARREG ANGLE", "LINEARREG_INTERCEPT", 
            "LOW", "Log", "Log Return", "Lower Bolinger", "LSMA", "MACD", "Macdhist", "Macdsignal", 
            "Math Series Operation", "Mean", "Median", "MFI", "OBV", "OHLC Spread", "OHLC Sum", "OPEN", 
            "Percentage Price Oscillator", "Pivot Point", "Power", "Ratio", "ROC", "ROCP", "RSI", "RSI Series", 
            "SAR", "SMA", "Sqrt", "ST SMA", "Stdev", "StochD", "Stochk", "StochRsiD", "StochRsiK", "Subtract Array", 
            "Sum", "SUPERTREND", "TEMA", "TR", "TRIMA", "TRIX", "Typical Price", "Ultimate Oscillator", 
            "Volume series", "VWMA", "WMA", "Zero Lag EMA", "Zscore", "Heikin Ashi", "Line Break", "Renko", 
            "Renko - closed candle", "Renko dynamic bricks"
          ],
          "description": "Name of the technical indicator or series keyword."
        },
        "timeframe": { "type": "string", "enum": ["1m", "3m", "5m", "10m", "15m", "30m", "1h", "1d", "1w", "day", "All"] },
        "position_offset": { "type": "integer", "description": "The position of the candle to fetch (-1 for previous, 0 for current)." },
        "inputs": {
          "type": "object",
          "description": "Indicator parameters (e.g., period, standard deviation, series source).",
          "additionalProperties": {
            "oneOf": [ { "type": "number" }, { "type": "string" }, { "$ref": "#/definitions/operand" } ]
          }
        },
        "instrument": { "$ref": "#/definitions/instrument_definition" }
      },
      "required": ["function_name", "timeframe", "position_offset", "instrument"]
    },
    
    "candle_pattern_function": {
        "description": "TA-Lib based candle pattern functions (always returns 1, -1, or 0/null).",
        "type": "object",
        "properties": {
          "pattern_name": {
            "type": "string",
            "enum": [
              "DRAGONFLY DOJI", "ENGULFING", "GRAVESTONE DOJI", "HAMMER", "HANGINGMAN", 
              "HARAMI", "INVERTED HAMMER", "MORNINGDOJISTAR", "MORNINGSTAR", "SHOOTINGSTAR"
            ]
          },
          "timeframe": { "type": "string", "enum": ["1m", "3m", "5m", "10m", "15m", "30m", "1h", "1d", "day", "All"] },
          "position_offset": { "type": "integer", "description": "Position of the candle to check (-1 for previous, 0 for current)." },
          "instrument": { "$ref": "#/definitions/instrument_definition" }
        },
        "required": ["pattern_name", "timeframe", "position_offset", "instrument"]
      },
      
    "real_time_utility_keyword": {
      "description": "Keywords that return non-series real-time data or perform basic math/logic.",
      "type": "object",
      "properties": {
        "keyword": { 
          "type": "string",
          "enum": [
            "LTP", "Ask Price", "Bid Price", "Bid Ask Diff", "VWAP", "Atmiv", "Max Ol Instrument", "Max Ol Strike", 
            "Total Ol", "PCR", "Change", "Change%", "Absolute", "Max", "Min", "Multiplier", "Round", 
            "Math Operation", "Required Capital", "Random Number(0.00-1.00)", 
            "Day", "Minute", "Hour", "Sec", "Week", "Week Day", "Year", "Year Day", "Date", "Today", "Tomorrow", 
            "Next Trading Day", "Current Month Expiry", "Current Week Expiry", "MCX Fut Expiry", "MCX Option Expiry", 
            "Previous Expiry", "Days Difference (D2-D1)", "Now", 
            "PNL", "Max Profit", "PNL Underlying", "Net Delta", "Net Gamma", "Net Theta", "Net Vega", "Net Quantity", 
            "EntryDate", "EntryTime", "EntryPrice", "EntryUnderlyingPrice", "LastRepairedDate", "LastRepairedPrice", 
            "LastRepairedTime", "LastRepairedUnderlyingPrice", "Previous Close", "Traded Value", "Volume",
            "Delta", "Gamma", "Theta", "Rho", "Iv", "Vega", "Delta Neutral", "Gamma Neutral", "Theta Neutral", 
            "Vega Neutral", "Lot Size", "Tick Size", "Futures", "Synthetic Futures", "Get Strike"
          ],
          "description": "The specific utility function or value to fetch."
        },
        "inputs": {
          "type": "object",
          "description": "Specific parameters required by the keyword (e.g., Instrument Name, Comparison value, or runtime variable name).",
          "additionalProperties": {
            "oneOf": [ { "$ref": "#/definitions/operand" }, { "$ref": "#/definitions/instrument_definition" }, { "type": "string" }, { "type": "number" } ]
          }
        }
      },
      "required": ["keyword"]
    },
    
    "special_function_keyword": {
      "description": "Complex, multi-input keywords that may return a series, strike, or perform an action.",
      "type": "object",
      "properties": {
        "keyword": {
          "type": "string",
          "enum": [
            "Traded Instrument", "Traded Instrument Name", "Positions Detail", "ORB", "Find Strike", 
            "Indicator Value (Time)", "Value When", "Leg Exit", "Leg SL trail", "Leg TSL", "Universal Exit TSL",
            "Init Var", "Set Runtime", "Get Runtime", "Get Runtime Number"
          ]
        },
        "params": {
          "type": "object",
          "description": "Detailed structured parameters for complex functions.",
          "additionalProperties": {
            "oneOf": [ { "$ref": "#/definitions/operand" }, { "$ref": "#/definitions/instrument_definition" }, { "type": "string" }, { "type": "number" } ]
          }
        }
      },
      "required": ["keyword", "params"]
    },
    
    "logic_group": {
      "type": "object",
      "properties": {
        "condition_type": { "type": "string", "const": "GROUP" },
        "connection_logic": { "type": "string", "enum": ["AND", "OR"] },
        "conditions": {
          "type": "array",
          "items": { "oneOf": [ { "$ref": "#/definitions/comparison_node" }, { "$ref": "#/definitions/logic_group" } ] },
          "minItems": 1
        }
      },
      "required": ["conditions"]
    },
    "comparison_node": {
      "type": "object",
      "properties": {
        "condition_type": { "type": "string", "const": "COMPARE" },
        "left": { "$ref": "#/definitions/operand" },
        "operator": { 
          "type": "string", 
          "enum": [">", "<", ">=", "<=", "==", "!=", "Crosses Above", "Crosses Below"] 
        },
        "right": { "$ref": "#/definitions/operand" }
      },
      "required": ["left", "operator", "right"]
    }
  },
  "properties": {
    "strategy_sets": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "set_index": { "type": "integer" },
          "phases": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "phase_type": { "type": "string", "enum": ["Entry", "Exit", "Repair_Once", "Repair_Continuous", "Universal_Exit"] },
                "conditions": {
                   "description": "Root logic block. If multiple conditions exist, use a Logic Group.",
                   "oneOf": [ { "$ref": "#/definitions/comparison_node" }, { "$ref": "#/definitions/logic_group" }, { "$ref": "#/definitions/special_function_keyword" } ]
                },
                "positions": {
                  "type": "array",
                  "description": "Only used for Entry and Repair phases.",
                  "items": {
                    "type": "object",
                    "properties": {
                      "instrument": { "$ref": "#/definitions/instrument_definition" },
                      "transaction_type": { "type": "string", "enum": ["BUY", "SELL"] },
                      "product_type": { "type": "string", "enum": ["MIS", "CNC", "NRML"] },
                      "quantity_setup": {
                        "type": "object",
                        "properties": {
                          "type": { "type": "string", "enum": ["Fixed Quantity", "Lots", "Value", "Delta Neutral", "Gamma Neutral", "Theta Neutral", "Vega Neutral"] },
                          "value": { "type": "number" }
                        },
                        "required": ["type", "value"]
                      }
                    },
                    "required": ["instrument", "transaction_type", "product_type", "quantity_setup"]
                  }
                }
              },
              "required": ["phase_type", "conditions"]
            }
          }
        }
      }
    }
  },
  "required": ["strategy_sets"]
}